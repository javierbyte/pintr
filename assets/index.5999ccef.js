var oe=Object.defineProperty,re=Object.defineProperties;var ae=Object.getOwnPropertyDescriptors;var X=Object.getOwnPropertySymbols;var se=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var Y=(e,t,n)=>t in e?oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,q=(e,t)=>{for(var n in t||(t={}))se.call(t,n)&&Y(e,n,t[n]);if(X)for(var n of X(t))ie.call(t,n)&&Y(e,n,t[n]);return e},P=(e,t)=>re(e,ae(t));const ce=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerpolicy&&(o.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?o.credentials="include":a.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}};ce();function K(e){const{data:t}=e.getImageData(0,0,e.canvas.width,e.canvas.height),{width:n,height:r}=e.canvas;let a=[];for(let o=0;o<r;o++)for(let s=0;s<n;s++)a[s]||(a[s]=[]),a[s][o]=Math.floor((t[o*n*4+s*4]+t[o*n*4+s*4+1]+t[o*n*4+s*4+2])/3);return a}function le(e,t={}){const{crop:n=!0,size:r}=t;return new Promise(a=>{const o=new window.Image;o.onload=function(){const c=t.canvas||document.createElement("canvas"),l=c.getContext("2d");let i=1;r&&(i=r/Math.max(o.width,o.height)),t.maxSize&&(o.width>t.maxSize||o.height>t.maxSize)&&(i=t.maxSize/Math.max(o.width,o.height));const d=Math.floor(o.width*i),u=Math.floor(o.height*i);if(n){c.width=r,c.height=r;const h=Math.min(o.width,o.height);l.drawImage(o,(o.width-h)/2,(o.height-h)/2,h,h,0,0,r,r)}else c.width=d,c.height=u,l.drawImage(o,0,0,d,u);const m=l.getImageData(0,0,l.canvas.width,l.canvas.height);m.ctx=l,a(m)},o.src=e})}function Z(e){e.beginPath();function t(a,o,s={}){const{color:c="#000",width:l=1}=s;e.beginPath(),e.lineWidth=l,e.moveTo(a[0],a[1]),e.lineTo(o[0],o[1]),e.strokeStyle=c,e.stroke()}function n(a,o){e.moveTo(a[0],a[1]),e.lineTo(o[0],o[1])}function r(a={}){const{color:o="#000",width:s=1}=a;e.lineWidth=s,e.strokeStyle=o,e.stroke(),e.beginPath()}return{line:t,lineBuffer:n,stroke:r}}const W=.1,k={r:.299+W,g:.587+W*-.5,b:.114+W*-.5};function de(e){let t=e.data,n=1/0,r=0,a=0;for(let s=0;s<t.length;s+=4){let c=t[s]*k.r+t[s+1]*k.g+t[s+2]*k.b;n=Math.min(n,c),r=Math.max(r,c),a+=c}a=Math.round(a/(t.length/4)),n+=32,r-=32;const o=255/(r-n);for(let s=0;s<t.length;s+=4){let c=t[s]*k.r+t[s+1]*k.g+t[s+2]*k.b;t[s]=Math.round(c*o)-n,t[s+1]=Math.round(c*o)-n,t[s+2]=Math.round(c*o)-n}return{canvasData:e,averageLightness:a}}function J(e,t,n){let r=0;const a=e[0],o=t[0]-e[0],s=e[1],c=t[1]-e[1],l=Math.max(Math.abs(o),Math.abs(c));for(let i=0;i<l;i++){const d=Math.round(a+o/l*i),u=Math.round(s+c/l*i);r+=n[d][u]}return Math.round(r/l)}function R(e,t){return t===void 0?Math.floor(Math.random()*e):Math.min(e,t)+Math.floor(Math.random()*Math.abs(e-t))}function Q(e,t){let n;return function(){clearTimeout(n);let r=arguments;n=setTimeout(function(){e.apply(this,r)},t||1)}}const ue=1080,x=1;let M=null,I=null,C=null;const N=document.createElement("canvas");async function ge(e,t={}){const{canvasDrawEl:n,onDraw:r,onFinish:a,onLoad:o}=t,s=await le(e,{size:ue,canvas:N,crop:!1}),c=s.width,l=s.height;N.width=c,N.height=l;const i=N.getContext("2d"),d=Z(i),u=n||document.createElement("canvas");u.width=c*x,u.height=l*x;const m=document.querySelector("#srcImg");m.style.aspectRatio=c/l;const h=u.getContext("2d");h.scale(x,x);const S=Z(h);console.log("> Starting PINTR"),o&&o({width:c,height:l});const{canvasData:y,averageLightness:T}=de(s);async function $({config:f}){console.log("> Render PINTR",f),C=new Date().getTime(),I=[],i.putImageData(y,0,0),M=K(i);let B=new Date().getTime(),H=[Math.floor(c/2),Math.floor(l/2)];function ee(){let w=H,E=f.singleLine?0:f.precisionRange;for(;E--;){let b=[R(c),R(l)];M[w[0]][w[1]]>M[b[0]][b[1]]&&(w=b)}let O=R(f.precisionRange,f.precisionRange*2),L,U=255;for(;O--;){let b=[R(c),R(l)];const _=J(w,b,M);_<=U&&(U=_,L=b)}U=J(w,L,M),I.push([w,L]),S.lineBuffer(w,L,{color:"#000"}),d.lineBuffer(w,L,{color:f.substractionColor}),H=L}const j=Math.floor(f.baseLineNumber/T*128);let z=j;function te(w){return new Promise(E=>{const O=new Date().getTime();for(;new Date().getTime()<O+15&&z-- >0;){if(w!==C)return;z%f.updateSampleRate===0&&(d.stroke({color:f.substractionColor,width:f.strokeWidth*1.5}),M=K(i)),ee()}S.stroke({color:f.addColor,width:f.strokeWidth*1}),window.requestAnimationFrame(E)})}async function ne(w){for(;z>0&&w===C;)await te(w),r&&r({coords:I});r&&r({coords:I}),a&&a({coords:I});let E=new Date().getTime();console.log("> Lines per second:",j/(E-B)*1e3)}ne(C)}return{render:$}}function he(e,{strokeWidth:t,size:n}){return`<svg viewBox="0 0 ${n[0]} ${n[1]}" xmlns="http://www.w3.org/2000/svg" stroke="black" stroke-width="${t}">
${e.map(r=>`<line x1="${r[0][0]}" y1="${r[0][1]}" x2="${r[1][0]}" y2="${r[1][1]}"/>`).join(`
`)}
</svg>
  `}function me(e,{strokeWidth:t,size:n}){return`<svg viewBox="0 0 ${n[0]} ${n[1]}" xmlns="http://www.w3.org/2000/svg">
  <polyline points="${e.map(r=>r[0].join(",")).join(" ")}" fill="none" stroke="black" stroke-width="${t}"/>
</svg>
  `}function fe(e,t){return console.warn(">generateSvg",t),t.singleLine?me(e,t):he(e,t)}function A(e,{smoothing:t=.15,strokeWidth:n,size:r}){const a=e.map(i=>i[0]),o=(i,d)=>{const u=d[0]-i[0],m=d[1]-i[1];return{length:Math.sqrt(Math.pow(u,2)+Math.pow(m,2)),angle:Math.atan2(m,u)}},s=(i,d,u,m)=>{const y=o(d||i,u||i),T=y.angle+(m?Math.PI:0),$=y.length*t,f=i[0]+Math.cos(T)*$,B=i[1]+Math.sin(T)*$;return[f,B]},c=(i,d,u)=>{const m=s(u[d-1],u[d-2],i),h=s(i,u[d-1],u[d+1],!0);return`C ${m[0]},${m[1]} ${h[0]},${h[1]} ${i[0]},${i[1]}`},l=(i,d)=>`<path d="${i.reduce((m,h,S,y)=>S===0?`M ${h[0]},${h[1]}`:`${m} ${d(h,S,y)}`,"")}" fill="none" stroke="black" stroke-width="${n}" />`;return`<svg viewBox="0 0 ${r[0]} ${r[1]}" xmlns="http://www.w3.org/2000/svg" stroke="black">
    ${l(a,c)}
  </svg>
  `}const we="./test.jpg";let v={},g={currentImgSrc:we,coords:null,width:null,height:null};async function G(e){const t=await ge(e,{canvasDrawEl:document.querySelector("canvas#draw"),onDraw({coords:n}){g.coords=n},onLoad({width:n,height:r}){document.documentElement.style.setProperty("--sizew",`${n/2}px`),document.documentElement.style.setProperty("--sizeh",`${r/2}px`),g.width=n,g.height=r},onFinish({coords:n}){if(!v.makeSmoothSvg)return;const r=A(n,P(q({},v),{size:[g.width,g.height],smoothing:Number(document.querySelector("#inputSmoothness").value)/100}));document.querySelector(".smooth-svg-container").innerHTML=r}});document.querySelector("#srcImg").style.backgroundImage=`url("${e}")`,document.querySelector(".loading").style.display="none",t.render({config:v})}function ve(e){if(e.preventDefault(),e.stopPropagation(),this.files&&this.files[0]){const t=new FileReader;t.addEventListener("load",function(n){g.currentImgSrc=n.target.result,G(n.target.result)}),t.readAsDataURL(this.files[0])}}function D(e,t){return t==="number"?Number(document.querySelector(e).value):t==="bool"?Boolean(Number(document.querySelector(e).value)):document.querySelector(e).value}function V(){const e=D("#lines","number"),t=D("#singleLine","bool"),n=D("#contrast","number"),r=D("#definition","number"),a=D("#strokeWidth","number"),o=D("#makeSmoothSvg","bool");v={addColor:"#000",updateSampleRate:90,baseLineNumber:72*e,substractionColor:`rgba(255, 255, 255, ${100-n}%)`,precisionRange:r,singleLine:t,strokeWidth:a,makeSmoothSvg:t&&o},document.querySelector(".experimental--smoth-svg--container").style.display=o?"block":"none",document.querySelector(".experimental--smoth-svg--container--warning").style.display=t?"none":"block",G(g.currentImgSrc)}let p=0;function pe(e){if(console.log("File(s) dropped"),e.preventDefault(),!e.dataTransfer.files||!e.dataTransfer.files[0])return;const t=new FileReader;t.addEventListener("load",function(n){g.currentImgSrc=n.target.result,G(n.target.result),document.body.classList.remove("-dragging"),p=0}),t.readAsDataURL(e.dataTransfer.files[0])}function Se(e){e.preventDefault(),e.stopPropagation()}function ye(e){e.stopPropagation(),p++,console.log(p),p?document.body.classList.add("-dragging"):document.body.classList.remove("-dragging")}function Le(e){e.stopPropagation(),p--,console.log(p),p?document.body.classList.add("-dragging"):document.body.classList.remove("-dragging")}const F=document.querySelector(".app");F.addEventListener("drop",pe);F.addEventListener("dragover",Se);F.addEventListener("dragenter",ye);F.addEventListener("dragleave",Le);document.querySelector("#inputImageFile").addEventListener("change",ve);document.querySelector("#inputImageButton").addEventListener("click",()=>{document.querySelector("#inputImageFile").click()});document.querySelectorAll("[data-start-drawing]").forEach(e=>{e.addEventListener("change",Q(V,256))});document.querySelector("#inputSmoothness").addEventListener("change",Q(()=>{const e=A(g.coords,P(q({},v),{size:[g.width,g.height],smoothing:document.querySelector("#inputSmoothness").value/100}));document.querySelector(".smooth-svg-container").innerHTML=e},128));document.querySelector("#download").addEventListener("click",()=>{const e=document.createElement("a");e.download="PINTR.png",e.href=document.querySelector("canvas#draw").toDataURL(),e.click()});document.querySelector("#downloadSvg").addEventListener("click",()=>{const e=document.createElement("a");e.download="PINTR.svg";const t=fe(g.coords,P(q({},v),{size:[g.width,g.height]})),n=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(n);e.href=r,e.click()});document.querySelector("#downloadSmoothSvg").addEventListener("click",()=>{const e=document.createElement("a");e.download="PINTR.svg";const t=A(g.coords,{CONFIG:v,size:[g.width,g.height],smoothing:document.querySelector("#inputSmoothness").value/100}),n=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(n);e.href=r,e.click()});V();
