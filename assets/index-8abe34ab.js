(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function s(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerpolicy&&(o.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?o.credentials="include":r.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=s(r);fetch(r.href,o)}})();async function Lt(t,e){return new Promise(s=>{const{crop:i=!0,size:r,maxSize:o}=e,n=new window.Image;n.onload=function(){const c=e.canvas||document.createElement("canvas"),S=c.getContext("2d");if(!S)throw new Error("Failed to 'getContext2d'");let v=1;r&&(v=r/Math.max(n.width,n.height)),e.maxSize&&(n.width>e.maxSize||n.height>e.maxSize)&&(v=e.maxSize/Math.max(n.width,n.height));const d=Math.floor(n.width*v),g=Math.floor(n.height*v);if(i){c.width=r||o||n.width,c.height=r||o||n.height;const u=Math.min(n.width,n.height);S.drawImage(n,(n.width-u)/2,(n.height-u)/2,u,u,0,0,c.width,c.height)}else c.width=d,c.height=g,S.drawImage(n,0,0,d,g);s({img:n,canvas:c,ctx:S})},n.src=t})}function it(t,e=255){const{data:s}=t.getImageData(0,0,t.canvas.width,t.canvas.height),{width:i,height:r}=t.canvas;let o=[];for(let n=0;n<r;n++)for(let a=0;a<i;a++){o[a]||(o[a]=new Uint8Array(r)),o[a][n]=Math.round((s[n*i*4+a*4]+s[n*i*4+a*4+1]+s[n*i*4+a*4+2])/3);const c=s[n*i*4+a*4+3];c!==255&&(o[a][n]=Math.round(o[a][n]*(c/255)+e*(1-c/255)))}return o}async function Et(t,e){const{ctx:s,canvas:i}=await Lt(t,e);return s.getImageData(0,0,i.width,i.height)}function at(t){t.beginPath();function e(r,o,n={color:"#000",width:1}){const{color:a="#000",width:c=1}=n;t.beginPath(),t.lineWidth=c,t.moveTo(r[0],r[1]),t.lineTo(o[0],o[1]),t.strokeStyle=a,t.stroke()}function s(r,o){t.moveTo(r[0],r[1]),t.lineTo(o[0],o[1])}function i(r={color:"#000",width:1}){const{color:o="#000",width:n=1}=r;t.lineWidth=n,t.strokeStyle=o,t.stroke(),t.beginPath()}return{line:e,lineBuffer:s,stroke:i}}const tt=.1,x={r:.299+tt,g:.587+tt*-.5,b:.114+tt*-.5};function Mt(t){let e=t.data,s=1/0,i=0,r=0;for(let n=0;n<e.length;n+=4){let a=e[n]*x.r+e[n+1]*x.g+e[n+2]*x.b;e[n+3]<128&&(a=255),s=Math.min(s,a),i=Math.max(i,a),r+=a}r=Math.round(r/(e.length/4)),s+=32,i-=32;const o=255/(i-s);for(let n=0;n<e.length;n+=4){let a=e[n]*x.r+e[n+1]*x.g+e[n+2]*x.b;e[n]=Math.round(a*o)-s,e[n+1]=Math.round(a*o)-s,e[n+2]=Math.round(a*o)-s}return{canvasData:t,averageLightness:r}}function z(t,e){return t<e?t+1:t>e?t-1:t}function b(t,e,s){let i=0,r=0,o=t[0],n=t[1];for(r+=1,i+=s[o][n];o!==e[0]||n!==e[1];){if(o===e[0])n=z(n,e[1]);else if(n===e[1])o=z(o,e[0]);else{const a=(o-t[0])/(e[0]-t[0]),c=(n-t[1])/(e[1]-t[1]);a<c?o=z(o,e[0]):n=z(n,e[1])}r+=1,i+=s[o][n]}return Math.round(i/r)}function I(t,e){return e===void 0?Math.floor(Math.random()*t):Math.min(t,e)+Math.floor(Math.random()*Math.abs(t-e))}function lt(t,e){let s=0;return function(...i){clearTimeout(s),s=window.setTimeout(()=>t.apply(this,i),e)}}function O(t,e){const s=[...e];if(s.sort((i,r)=>i[0]-r[0]),t<s[0][0]||t>s[s.length-1][0])return console.error(`Value "${t}" out of range`,{value:t,tweens:e,sortedTweens:s}),t;for(const i in e){const r=e[i];if(r[0]===t)return r[1];if(r[0]>t){const o=e[Number(i)-1],n=r[0]-o[0],a=(t-o[0])/n;return a*r[1]+(1-a)*o[1]}}return t}const It=1080,G=1;let y=[],F=[],_=new Date().getTime()-1;const H=document.createElement("canvas");async function Tt(t,{canvasDrawEl:e,onDraw:s,onFinish:i,onLoad:r}){const o=await Et(t,{size:It,canvas:H,crop:!1}),n=o.width,a=o.height;H.width=n,H.height=a;const c=H.getContext("2d"),S=at(c),v=e||document.createElement("canvas");v.width=n*G,v.height=a*G;const d=document.querySelector("#srcImg"),g=v.getContext("2d");g.fillStyle="white",g.fillRect(0,0,n,a),d.style.aspectRatio=String(n/a),g.scale(G,G);const u=at(g);console.log("> Starting PINTR"),r({width:n,height:a});const{canvasData:w,averageLightness:E}=Mt(o);async function q(D){console.log("> Render PINTR",D);const{opacity:N,density:W,singleLine:Y,contrast:K,definition:ht,strokeWidth:mt}=D;_=new Date().getTime(),F=[];const A=O(mt,[[0,.5],[5,2],[15,24]]),T=Math.round(O(ht,[[0,3],[50,20],[100,75]])),ft=Math.round(O(W,[[0,750],[50,4200],[100,12e3]])/Math.pow(A,.7));console.log("Real stroke",A);const Z=2,ot=`rgba(0, 0, 0, ${N})`,J=`rgba(255, 255, 255, ${O(K,[[0,1],[50,.5],[100,.15]])*N/Z})`;console.info({PLUS_COLOR:ot,MINUS_COLOR:J});const wt=100-Math.floor(T/2);if(!c)throw new Error("Canvas error");c.putImageData(w,0,0),y=it(c);let pt=new Date().getTime(),rt=[Math.floor(n/2),Math.floor(a/2)];function St(){let l=rt,B=I(T,T*2),f=[I(n),I(a)],m=255;for(;B--;){if(Y){const p=[I(n),I(a)],M=j(l,p,.95),R=j(l,p,.9),C=b(l,p,y);if(C<=m&&(m=C,l=l,f=p),Math.random()<T/100){const k=b(l,M,y);k<=m&&(m=k,l=l,f=M)}if(Math.random()<T/100){const k=b(l,R,y);k<=m&&(m=k,l=l,f=R)}}else{const p=[I(n),I(a)],M=[I(n),I(a)],R=j(p,M,.25),C=j(p,M,.75),k=b(p,M,y);if(k<=m&&(m=k,l=p,f=M),Math.random()/3<T/100){const $=b(R,M,y);$<=m&&(m=$,l=R,f=M)}if(Math.random()/2<T/100){const $=b(p,C,y);$<=m&&(m=$,l=p,f=C)}if(Math.random()<T/100){const $=b(R,C,y);$<=m&&(m=$,l=R,f=C)}}m=b(l,f,y)}F.push([l,f]),u.lineBuffer(l,f),S.lineBuffer(l,f),rt=f}const st=Math.floor(ft/E*128);let Q=st;function vt(l){return new Promise(B=>{const f=new Date().getTime();for(;new Date().getTime()<f+15&&Q-- >0;){if(l!==_)return;if(Q%wt===0){if(S.stroke({color:J,width:A*Z}),!c)throw new Error("Canvas error");y=it(c)}St()}S.stroke({color:J,width:A*Z}),u.stroke({color:ot,width:A}),window.requestAnimationFrame(B)})}async function yt(l){for(;Q>0&&l===_;)await vt(l),s&&s({coords:F});s&&s({coords:F}),i&&i({coords:F});let B=new Date().getTime();console.log("> Lines per second:",st/(B-pt)*1e3)}yt(_)}return{render:q}}function j(t,e,s){const i=s===void 0?.5:s;return[Math.round(e[0]*i+t[0]*(1-i)),Math.round(e[1]*i+t[1]*(1-i))]}function kt(t,{strokeWidth:e=1,size:s,opacity:i}){const r=`rgba(0, 0, 0, ${i})`;return`<svg viewBox="0 0 ${s[0]} ${s[1]}" xmlns="http://www.w3.org/2000/svg" stroke="${r}" stroke-width="${e}">
${t.map(o=>`<line x1="${o[0][0]}" y1="${o[0][1]}" x2="${o[1][0]}" y2="${o[1][1]}"/>`).join(`
`)}
</svg>
  `}function $t(t,{strokeWidth:e=1,size:s,opacity:i}){const r=`rgba(0, 0, 0, ${i})`;return`<svg viewBox="0 0 ${s[0]} ${s[1]}" xmlns="http://www.w3.org/2000/svg">
  <polyline points="${t.map(o=>o[0].join(",")).join(" ")}" fill="none" stroke="${r}" stroke-width="${e}"/>
</svg>
  `}function bt(t,e){return console.warn(">generateSvg",e),e.singleLine&&e.opacity===1?$t(t,e):kt(t,e)}const V=64;function et(t,{smoothingAmount:e=50,rawSmoothingAmount:s,strokeWidth:i=1,size:r}){const o=t.map(d=>d[0]),n=s||O(e,[[0,0],[50,.1],[100,1]]),a=(d,g)=>{const u=g[0]-d[0],w=g[1]-d[1];return{length:Math.sqrt(Math.pow(u,2)+Math.pow(w,2)),angle:Math.atan2(w,u)}},c=(d,g,u,w)=>{const D=a(g||d,u||d),N=D.angle+(w?Math.PI:0),W=D.length*n,Y=d[0]+Math.cos(N)*W,K=d[1]+Math.sin(N)*W;return[Y,K]},S=(d,g,u)=>{const w=c(u[g-1],u[g-2],d),E=c(d,u[g-1],u[g+1],!0);return`C ${w[0]},${w[1]} ${E[0]},${E[1]} ${d[0]},${d[1]}`},v=(d,g)=>`<path d="${d.reduce((w,E,q,D)=>q===0?`M ${E[0]},${E[1]}`:`${w} ${g(E,q,D)}`,"")}" fill="none" stroke="black" stroke-width="${i}" />`;return`<svg viewBox="${-1*V} ${-1*V} ${r[0]+V*2} ${r[1]+V*2}" xmlns="http://www.w3.org/2000/svg" stroke="black">
    ${v(o,S)}
  </svg>
  `}const Dt="./test.jpg";let L=dt(),h={currentImgSrc:Dt,coords:[],width:512,height:512};async function nt(t){const e=document.querySelector("canvas#draw");if(!e)throw new Error;const s=await Tt(t,{canvasDrawEl:e,onDraw({coords:o}){h.coords=o},onLoad({width:o,height:n}){document.documentElement.style.setProperty("--sizew",`${o/2}px`),document.documentElement.style.setProperty("--sizeh",`${n/2}px`),h.width=o,h.height=n},onFinish({coords:o}){if(!L.makeSmoothSvg)return;const n=et(o,{...L,size:[h.width,h.height]}),a=document.querySelector(".smooth-svg-container");a.innerHTML=n}}),i=document.querySelector("#srcImg"),r=document.querySelector(".loading");i&&r&&(i.style.backgroundImage=`url("${t}")`,r.style.display="none"),s.render(L)}function Rt(t){t.preventDefault(),t.stopPropagation();const e=t.target;if(!e||!e.files)return;const s=e.files[0];if(s){const i=new FileReader;i.addEventListener("load",function(r){!r||!r.target||(h.currentImgSrc=String(r.target.result),nt(String(r.target.result)))}),i.readAsDataURL(s)}}function P(t){const e=document.querySelector(t);return e?Number(e.value):0}function ct(t){const e=document.querySelector(t);return e?Boolean(Number(e.value)):!1}function dt(){const t=P("#opacity"),e=P("#density"),s=ct("#singleLine"),i=P("#contrast"),r=P("#definition"),o=P("#strokeWidth"),n=ct("#makeSmoothSvg"),a=P("#smoothingAmount");return{opacity:t,density:e,singleLine:s,contrast:i,definition:r,strokeWidth:o,makeSmoothSvg:n,smoothingAmount:a}}function gt(){L=dt();const t=document.querySelector(".experimental--smoth-svg--container");t.style.display=L.makeSmoothSvg?"block":"none";const e=document.querySelector(".experimental--smoth-svg--container--warning");e.style.display=L.singleLine?"none":"block",nt(h.currentImgSrc)}let U=0;function Ct(t){if(t.preventDefault(),!t.dataTransfer||!t.dataTransfer.files||!t.dataTransfer.files[0])return;const e=new FileReader;e.addEventListener("load",function(s){!s||!s.target||!s.target.result||(h.currentImgSrc=String(s.target.result),nt(String(s.target.result)),document.body.classList.remove("-dragging"),U=0)}),e.readAsDataURL(t.dataTransfer.files[0])}function Pt(t){t.preventDefault(),t.stopPropagation()}function xt(t){t.stopPropagation(),U++,U?document.body.classList.add("-dragging"):document.body.classList.remove("-dragging")}function qt(t){t.stopPropagation(),U--,U?document.body.classList.add("-dragging"):document.body.classList.remove("-dragging")}const X=document.querySelector(".app");X.addEventListener("drop",Ct);X.addEventListener("dragover",Pt);X.addEventListener("dragenter",xt);X.addEventListener("dragleave",qt);const ut=document.querySelector("#inputImageFile");ut.addEventListener("change",Rt);const Nt=document.querySelector("#inputImageButton");Nt.addEventListener("click",()=>{ut.click()});document.querySelectorAll("[data-start-drawing]").forEach(t=>{t.addEventListener("change",lt(gt,32))});const At=document.querySelector("#smoothingAmount");At.addEventListener("change",lt(()=>{L.smoothingAmount=P("#smoothingAmount");const t=et(h.coords,{...L,size:[h.width,h.height]}),e=document.querySelector(".smooth-svg-container");e.innerHTML=t},128));const Bt=document.querySelector("#download");Bt.addEventListener("click",()=>{const t=document.createElement("a"),e=document.querySelector("canvas#draw");t.download="PINTR.png",t.href=e.toDataURL(),t.click()});const Ft=document.querySelector("#downloadSvg");Ft.addEventListener("click",()=>{const t=document.createElement("a");t.download="PINTR.svg";const e=bt(h.coords,{...L,size:[h.width,h.height]}),s=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),i=URL.createObjectURL(s);t.href=i,t.click()});const Ot=document.querySelector("#downloadSmoothSvg");Ot.addEventListener("click",()=>{const t=document.createElement("a");t.download="PINTR.svg";const e=et(h.coords,{...L,size:[h.width,h.height]}),s=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),i=URL.createObjectURL(s);t.href=i,t.click()});gt();
